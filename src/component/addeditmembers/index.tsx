// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import React, { useState } from "react";
import {
  PlasmicAddEditMembers,
  DefaultAddEditMembersProps,
} from "component/plasmic/shared/PlasmicAddEditMembers";
import { useForm } from "react-hook-form";
import { getUser } from "module/store";
import MemberItem from "component/memberitem";
import { IUser } from "module/interface/user";
import emailjs from "emailjs-com";
// import { init } from "emailjs-com";
// init("user_mRFm0l0xiY3CK24bkQMdu");

interface AddEditMembersProps extends DefaultAddEditMembersProps {}

function AddEditMembers(props: AddEditMembersProps) {
  const { handleSubmit, register, reset } = useForm();
  const defaultMembers = [];
  const me = getUser();
  defaultMembers.push(me);

  const [members, setMembers] = useState(defaultMembers);

  const handleInvite = (data: any) => {
    const email = data.email;
    const user: IUser = { name: email, userType: "isRequested", id: email };
    const newMembers = members;

    newMembers.push(user);

    const templateParams = {
      to_name: "Marcus",
      user_email: email,
      from_name: "Elon Musk",
      message: "hello there my old friend!",
    };

    //send invite link
    emailjs
      .send(
        "service_4fkfbos",
        "template_iifu2kt",
        templateParams,
        "user_mRFm0l0xiY3CK24bkQMdu"
      )
      .then(
        function (response) {
          console.log("SUCCESS!", response.status, response.text);
        },
        function (error) {
          console.log("FAILED...", error);
        }
      );

    setMembers(newMembers);
    reset();
  };

  return (
    <PlasmicAddEditMembers
      {...props}
      form={{
        onSubmit: handleSubmit(handleInvite),
      }}
      email={{
        register: register(),
        name: "email",
      }}
      invite={{
        type: "submit",
      }}
      membersContainer={{
        children: members.map((user) => (
          <MemberItem
            userName={user?.name}
            userInitials={
              user?.name
                .split(" ")
                .map((n: string) => n[0])
                .join("") ?? ""
            }
            userVariant={user?.userType ?? "isAdmin"}
          />
        )),
      }}
    />
  );
}

export default AddEditMembers;
