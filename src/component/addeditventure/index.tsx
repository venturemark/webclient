// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import * as React from "react";
import {
  PlasmicAddEditVenture,
  DefaultAddEditVentureProps,
} from "component/plasmic/shared/PlasmicAddEditVenture";
import { INewVenture, IVenture } from "module/interface/venture";
import { useHistory, useParams, useLocation } from "react-router-dom";
import { useGetToken } from "module/auth";
import { ventureNameError } from "module/errors";
import { makeVentureUrl } from "module/helpers";
import { useCreateVenture } from "module/hook/venture";

interface ParamsType {
  timelineSlug: string;
  ventureSlug: string;
}

interface AddEditVentureProps extends DefaultAddEditVentureProps {
  setIsActive: any;
  currentVenture: IVenture;
  handleSubmit: any;
  register: any;
  reset: any;
  errors: any;
}

function AddEditVenture(props: AddEditVentureProps) {
  const {
    setIsActive,
    handleSubmit,
    register,
    reset,
    errors,
    currentVenture,
    ...rest
  } = props;
  const { ventureSlug } = useParams<ParamsType>();
  const token = useGetToken();
  const { mutate: saveVenture } = useCreateVenture();

  const history = useHistory();
  const venture = currentVenture;
  const url = useLocation();

  const handleCreate = (data: any) => {
    const handle = data.name.toLowerCase().replace(/\s/g, "");
    const venture: INewVenture = {
      name: data.name,
      desc: data.description,
      url: makeVentureUrl(handle),
      token: token,
    };

    saveVenture(venture);
    reset();
    history.push(`/${handle}/feed`);
  };

  return (
    <PlasmicAddEditVenture
      variantState={ventureSlug ? "isEdit" : undefined}
      settings={{
        onSubmit: handleSubmit(handleCreate),
      }}
      name={{
        register: register({ required: true }),
        name: "name",
        defaultValue:
          url?.pathname === "/newventure" ? "" : venture?.name ?? "",
        errorMessage: errors.name && ventureNameError,
      }}
      description={{
        register: register(),
        name: "description",
        defaultValue:
          url?.pathname === "/newventure" ? "" : venture?.desc ?? "",
      }}
      url={{
        register: register(),
        name: "url",
        defaultValue: venture?.url ?? "",
      }}
      membersWrite={{}}
      {...rest}
    />
  );
}

export default AddEditVenture;
