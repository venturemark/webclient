import { useAuth0 } from "@auth0/auth0-react";
// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import React, { useContext, useEffect, useState } from "react";
import { useNavigate } from "react-router";

import { UserContext } from "component/app";
import {
  DefaultHeaderProps,
  PlasmicHeader,
} from "component/plasmic/shared/PlasmicHeader";
import { IUser } from "module/interface/user";

interface HeaderProps extends DefaultHeaderProps {
  isVisible: any;
  setIsVisible: any;
  user: IUser;
}

function Header(props: HeaderProps) {
  const { isVisible, setIsVisible, user, ...rest } = props;
  const { isAuthenticated } = useAuth0();
  const [profileDropdown, setProfileDropdown] = useState(false);

  const mobileSidebar =
    isVisible === "mobileSidebar" ? undefined : "mobileSidebar";

  const userContext = useContext(UserContext);
  const hasUser = userContext?.user;

  useEffect(() => {
    const handleWindowClick = () => setProfileDropdown(false);
    if (profileDropdown) {
      window.addEventListener("click", handleWindowClick);
      window.addEventListener("keydown", handleWindowClick);
    } else {
      window.removeEventListener("click", handleWindowClick);
      window.removeEventListener("keydown", handleWindowClick);
    }
    return () => {
      window.removeEventListener("click", handleWindowClick);
      window.removeEventListener("keydown", handleWindowClick);
    };
  }, [profileDropdown, setProfileDropdown]);

  const navigate = useNavigate();

  return (
    <PlasmicHeader
      {...rest}
      profileDropdown={profileDropdown}
      toggleMobileSidebar={{ onClick: () => setIsVisible(mobileSidebar) }}
      svg={{
        wrap(node) {
          return (
            <a
              href="/"
              onClick={(e) => {
                e.preventDefault();
                navigate("/");
              }}
            >
              {node}
            </a>
          );
        },
      }}
      views={
        hasUser && isAuthenticated
          ? "userAccount"
          : isAuthenticated
          ? undefined
          : "publicView"
      }
      avatar={{
        setProfileDropdown,
        profileDropdown,
        user,
      }}
      dropdown={{
        profileDropdown,
        setProfileDropdown,
        isVisible,
        setIsVisible,
        user,
      }}
    />
  );
}

export default Header;
