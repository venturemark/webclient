// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import React, { useRef, useEffect } from "react";
import { useForm } from "react-hook-form";
import { format } from "date-fns";
import {
  PlasmicSidebar,
  DefaultSidebarProps,
} from "component/plasmic/shared/PlasmicSidebar";
import SidebarItem, { TimelineType } from "component/sidebaritem";
interface SidebarProps extends DefaultSidebarProps {
  timelines: TimelineType[];
  setTimelines: React.Dispatch<React.SetStateAction<TimelineType[]>>;
  hideSidebar: boolean;
  setHideSidebar: React.Dispatch<React.SetStateAction<boolean>>;
}

type FormInputs = {
  name: string;
};

function Sidebar(props: SidebarProps) {
  const { timelines, setHideSidebar, setTimelines, hideSidebar } = props;
  const { register, handleSubmit, reset, watch } = useForm<FormInputs>();
  const nameRef = useRef<HTMLInputElement | null>(null);
  const hasValue = watch("name") ? true : false;

  const handleAddTimeline = (data: FormInputs) => {
    if (!data.name) {
      return;
    }

    const timeline = {
      name: data.name,
      date: format(new Date(), "PP"),
      id: format(new Date(), "PP"),
    };
    const sortedTimelines = [timeline, ...timelines].sort((a, b) =>
      a.name.localeCompare(b.name)
    );
    setTimelines(sortedTimelines);

    //reset form
    reset({
      name: "",
    });
  };

  useEffect(() => {
    if (!hideSidebar) {
      nameRef?.current?.focus();
    }
  }, [hideSidebar]);

  return (
    <PlasmicSidebar
      homeItem={{
        onClick: () => alert("home pressed!"),
        onPress: () => setHideSidebar(!hideSidebar),
      }}
      settingsItem={{
        onClick: () => alert("menu pressed!"),
      }}
      timelinesContainer={{
        children: timelines.map((timeline) => (
          <SidebarItem
            name={timeline.name}
            onClick={() => alert("timeline pressed!")}
          />
        )),
      }}
      addTimeline={{
        "aria-label": "Toggle sidebar",
        onPress: () => {
          if (!hasValue) {
            setHideSidebar(!hideSidebar);
          } else {
            handleSubmit(handleAddTimeline)();
          }
        },
      }}
      sidebarForm={{
        onSubmit: handleSubmit(handleAddTimeline),
      }}
      addTimelineInput={{
        name: "name",
        ref: (e) => {
          register(e);
          nameRef.current = e;
        },
      }}
    />
  );
}

export default Sidebar;
