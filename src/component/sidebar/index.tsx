// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import React, { useRef, useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import {
  PlasmicSidebar,
  DefaultSidebarProps,
} from 'component/plasmic/shared/PlasmicSidebar';
import SidebarItem from 'component/sidebaritem';
import { ITimeline, INewTimeline } from 'module/interface/timeline';
import * as api from 'module/api';
import { useMutation, useQueryClient } from 'react-query';

interface SidebarProps extends DefaultSidebarProps {
  timelines: ITimeline[];
  setTimelines: React.Dispatch<React.SetStateAction<ITimeline[]>>;
  setCurrentTimeline: React.Dispatch<React.SetStateAction<ITimeline>>;
  addTimelineFocused: boolean;
  refresh: boolean;
  setRefresh: React.Dispatch<React.SetStateAction<boolean>>;
  userId: string;
  organizationId: string;
}

type FormInputs = {
  name: string;
};

function Sidebar(props: SidebarProps) {
  const {
    timelines,
    setTimelines,
    addTimelineFocused,
    setRefresh,
    setCurrentTimeline,
    userId,
    organizationId,
  } = props;
  const {
    register,
    handleSubmit,
    reset,
    watch,
  } = useForm<FormInputs>();
  const nameRef = useRef<HTMLInputElement | null>(null);
  const hasValue = watch('name') ? true : false;
  const [hasInput, setHasInput] = useState(false);
  const sortedTimelines = timelines.sort((a, b) =>
    a.name.localeCompare(b.name),
  );

  const queryClient = useQueryClient();

  // Mutations
  // const audienceMutation = useMutation<any, any, any>((name) => {
  //   return api.API.Audience.Create(
  //     name,
  //     userId,
  //     organizationId,
  //   );
  // },{
  //   onSuccess: () => {
  //     // Invalidate and refetch
  //     queryClient.invalidateQueries('audience')
  //   },
  // })

  const timelineMutation = useMutation<any, any, any>(
    (newTimeline) => {
      return api.API.Timeline.Create(newTimeline);
    },
    {
      onSuccess: () => {
        // Invalidate and refetch
        queryClient.invalidateQueries('timeline');
      },
    },
  );

  const handleAddTimeline = (data: FormInputs) => {
    if (!data.name) {
      return;
    }

    const newTimeline: INewTimeline = {
      name: data.name,
      desc: 'Lorem Ipsum...',
      userId,
      audienceId: '1',
      organizationId,
    };

    // audienceMutation(timelineId)
    timelineMutation.mutate(newTimeline);

    //reset form
    reset({
      name: '',
    });
  };

  useEffect(() => {
    if (addTimelineFocused) {
      nameRef?.current?.focus();
    }
  }, [addTimelineFocused]);

  return (
    <PlasmicSidebar
      hasValue={hasValue}
      organizationName={{
        hasInput: hasInput,
        setHasInput: setHasInput,
      }}
      hasInput={hasInput}
      sidebarForm={{
        onSubmit: handleSubmit(handleAddTimeline),
      }}
      timelinesContainer={{
        children: sortedTimelines.map((timeline) => (
          <SidebarItem
            name={timeline.name}
            isCurrent={timeline.isCurrent}
            onClick={() => {
              const name = timeline.name;

              const thisTimeline = timelines.filter(
                (clickedTimeline) =>
                  timeline.timelineId === clickedTimeline.timelineId,
              )[0];

              const currentTimelines = timelines.map((timeline) => {
                const isCurrent =
                  name === timeline.name
                    ? !timeline.isCurrent
                    : false;

                return { ...timeline, isCurrent: isCurrent };
              });
              setTimelines(currentTimelines);
              setCurrentTimeline(thisTimeline);
              setRefresh(true);
            }}
          />
        )),
      }}
      addTimelineInput={{
        name: 'name',
        ref: (e) => {
          register(e);
          nameRef.current = e;
        },
      }}
    />
  );
}

export default Sidebar;
